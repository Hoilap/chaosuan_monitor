import subprocess
import time
import requests
import os
import re
from datetime import datetime, timedelta
from notifier import NotificationManager
from get_token import get_bihu_token

log = "0001-01-01 00:00:00 +0000 UTC	Normal	Scheduled	Successfully assigned 13957/deeplearni-24131954-wqn7r to an19"

# ==================== é…ç½®åŒº ====================
# 1. åŸºç¡€ä¿¡æ¯ (ä»ä½ æä¾›çš„ API ä¸­æå–)
CLUSTER = "k8s_xingyiAI"
# ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
# åŒ¹é…è§„åˆ™ï¼šæ‰¾åˆ° "Successfully assigned " åé¢çš„ "å‘½åç©ºé—´/Podå" ä»¥åŠ "to" åé¢çš„ "èŠ‚ç‚¹å"
match = re.search(r"Successfully assigned .*/(\S+) to (\S+)", log)
if match:
    POD_NAME = match.group(1)  # æå–ç¬¬ä¸€ä¸ªæ‹¬å·ï¼šdeeplearni-22161940-rcpzt
    NODE_NAME = match.group(2) # æå–ç¬¬äºŒä¸ªæ‹¬å·ï¼šan9
    # æå– JOB_ID (é€šå¸¸æ˜¯ POD_NAME å»æ‰æœ€åçš„ä¸€ä¸ªçŸ­æ¨ªçº¿åŠå…¶åçš„éšæœºå­—ç¬¦ä¸²)
    # ä½¿ç”¨ rpartition ä»å³ä¾§åˆ‡å‰²ï¼Œå–ç¬¬ä¸€éƒ¨åˆ†
    JOB_ID = POD_NAME.rpartition('-')[0]

# 2. é‰´æƒä¿¡æ¯ (å¿…é¡»å¡«å…¥ä½ æŠ“åˆ°çš„æœ€æ–° bihu-token)
BIHU_TOKEN = get_bihu_token()

# 3. ç›‘æ§åˆ¤å®šå‚æ•°
IDLE_THRESHOLD_MB = 3  # æ˜¾å­˜å ç”¨ä½äº 100MB è®¤ä¸ºé—²ç½®
MAX_IDLE_COUNT = 4      # è¿ç»­é—²ç½®æ¬¡æ•°è¾¾åˆ°è¯¥å€¼åˆ™è§¦å‘å…³é—­
CHECK_INTERVAL = 120      # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰

# 4. API åœ°å€
METRIC_URL = "https://starlight.nscc-gz.cn/api/monitor/metric"
DELETE_URL = f"https://starlight.nscc-gz.cn/api/job/running/{CLUSTER}/{JOB_ID}"

# 5. é€šçŸ¥é…ç½®ï¼ˆå¯é€‰ - ç•™ç©ºåˆ™ä¸å‘é€é€šçŸ¥ï¼‰
# ============== é‚®ä»¶é€šçŸ¥é…ç½® ==============
ENABLE_EMAIL = False  # æ˜¯å¦å¯ç”¨é‚®ä»¶é€šçŸ¥
SMTP_SERVER = "smtp.qq.com"  # SMTPæœåŠ¡å™¨ (QQé‚®ç®±: smtp.qq.com, 163é‚®ç®±: smtp.163.com, Gmail: smtp.gmail.com)
SMTP_PORT = 465  # SMTPç«¯å£ (SSLé€šå¸¸ç”¨465)
SENDER_EMAIL = ""  # å‘ä»¶äººé‚®ç®±
SENDER_PASSWORD = ""  # é‚®ç®±å¯†ç æˆ–æˆæƒç 
RECEIVER_EMAIL = ""  # æ”¶ä»¶äººé‚®ç®±

# ============== Serveré…±(å¾®ä¿¡)é€šçŸ¥é…ç½® ==============
ENABLE_SERVERCHAN = False  # æ˜¯å¦å¯ç”¨Serveré…±é€šçŸ¥
SERVERCHAN_KEY = ""  # Serveré…±SendKey (ä» https://sct.ftqq.com/ è·å–)

# ============== é’‰é’‰æœºå™¨äººé€šçŸ¥é…ç½® ==============
ENABLE_DINGTALK = True  # æ˜¯å¦å¯ç”¨é’‰é’‰é€šçŸ¥
DINGTALK_WEBHOOK = "https://oapi.dingtalk.com/robot/send?access_token=8462fe5ab6ae20d68a6bd0c49377fe5aa038c20684b1323e191d9124a28783d6"  # é’‰é’‰æœºå™¨äººWebhookåœ°å€
DINGTALK_SECRET = "SEC3dfbc622eaad681399357a4d885ef1f8eb3ad590b1d2918d77ef25d673ba440b"  # é’‰é’‰æœºå™¨äººåŠ ç­¾å¯†é’¥ï¼ˆå¯é€‰ï¼‰
# ===============================================

HEADERS = {
    "bihu-token": BIHU_TOKEN,
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
    "accept": "application/json, text/plain, */*"
}

def get_current_gpu_memory():
    """ä» API è·å–æœ€æ–°çš„æ˜¾å­˜å ç”¨å€¼"""
    # åŠ¨æ€ç”Ÿæˆæœ€è¿‘ä¸€å°æ—¶çš„æ—¶é—´èŒƒå›´ï¼ˆAPIè¦æ±‚ï¼‰
    now = datetime.utcnow()
    start_time = (now - timedelta(minutes=60)).isoformat() + "Z"
    end_time = now.isoformat() + "Z"

    params = {
        "node_list": NODE_NAME,
        "pod_list": POD_NAME,
        "metric": "gpu_memory",
        "start": start_time,
        "end": end_time,
        "limit": "10", # æˆ‘ä»¬åªéœ€è¦æœ€æ–°çš„å‡ ä¸ªç‚¹
        "cluster_name": CLUSTER,
        "job_name": JOB_ID,
        "job_id": JOB_ID
    }

    try:
        response = requests.get(METRIC_URL, params=params, headers=HEADERS, timeout=15,verify=False  )
        res_json = response.json()
        
        if res_json.get("code") != 200:
            print(f"API error: {res_json.get('info')}")
            return None

        # è§£æ spec -> device -> data
        devices = res_json.get("spec", {}).get("device", [])
        if not devices:
            print(res_json)
            print("Can't find device data in response.")
            return None

        max_usage = 0
        for dev in devices:
            data_points = dev.get("data", [])
            if data_points:
                # å–æœ€åä¸€ä¸ªæ•°æ®ç‚¹ [timestamp, value] çš„ value
                latest_val = float(data_points[-1][1])
                max_usage = max(max_usage, latest_val)
        
        return max_usage
    
    except requests.exceptions.SSLError as e:
        print(f"âŒ SSLè¿æ¥é”™è¯¯: {e}")
        # å¦‚æœé‡åˆ° SSL EOFï¼Œé€šå¸¸ç­‰å¾…å‡ ç§’é‡è¯•å¯èƒ½æœ‰æ•ˆ
        return None 
    
    except Exception as e:
        print(f"Request data exception: {e}")
        return None

def stop_job():
    """Send DELETE request to stop the job"""
    print(f"\n[{datetime.now()}] !!! Triggering auto shutdown command !!!")
    try:
        res = requests.delete(DELETE_URL, headers=HEADERS, timeout=15)
        if res.status_code == 200:
            print(">>> Platform confirmed job shutdown, billing stopped.")
            return True
        else:
            print(f">>> Shutdown failed: {res.status_code} {res.text}")
    except Exception as e:
        print(f">>> Command send exception: {e}")
    return False

def setup_notifications():
    """é…ç½®é€šçŸ¥ç®¡ç†å™¨"""
    notif_mgr = NotificationManager()
    
    # æ·»åŠ é‚®ä»¶é€šçŸ¥
    if ENABLE_EMAIL and SENDER_EMAIL and RECEIVER_EMAIL:
        notif_mgr.add_email_notifier(
            SMTP_SERVER, SMTP_PORT, 
            SENDER_EMAIL, SENDER_PASSWORD, 
            RECEIVER_EMAIL
        )
    
    # æ·»åŠ Serveré…±é€šçŸ¥
    if ENABLE_SERVERCHAN and SERVERCHAN_KEY:
        notif_mgr.add_serverchan_notifier(SERVERCHAN_KEY)
    
    # æ·»åŠ é’‰é’‰é€šçŸ¥
    if ENABLE_DINGTALK and DINGTALK_WEBHOOK:
        notif_mgr.add_dingtalk_notifier(DINGTALK_WEBHOOK, DINGTALK_SECRET or None)
    
    return notif_mgr

def send_notification(notif_mgr, title, message):
    """å‘é€é€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†é€šçŸ¥æ–¹å¼ï¼‰"""
    if notif_mgr.notifiers:
        notif_mgr.send_all(title, message)


def main():
    idle_counter = 0
    print(f"Starting monitoring job: {JOB_ID}")
    print(f"Criteria: GPU memory < {IDLE_THRESHOLD_MB}MB for {MAX_IDLE_COUNT} consecutive checks")
    
    # åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨
    notif_mgr = setup_notifications()
    
    # å‘é€ç›‘æ§å¯åŠ¨é€šçŸ¥
    send_notification(
        notif_mgr,
        "ğŸš€ GPUç›‘æ§å·²å¯åŠ¨",
        f"ä»»åŠ¡ID: {JOB_ID}\n"
        f"èŠ‚ç‚¹: {NODE_NAME}\n"
        f"Pod: {POD_NAME}\n"
        f"é—²ç½®é˜ˆå€¼: GPUæ˜¾å­˜ < {IDLE_THRESHOLD_MB}MB\n"
        f"è§¦å‘æ¡ä»¶: è¿ç»­é—²ç½®{MAX_IDLE_COUNT}æ¬¡ï¼ˆçº¦{MAX_IDLE_COUNT * CHECK_INTERVAL // 60}åˆ†é’Ÿï¼‰\n"
        f"æ£€æŸ¥é—´éš”: {CHECK_INTERVAL}ç§’\n"
        f"å¯åŠ¨æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    )

    while True:
        usage = get_current_gpu_memory()
        
        if usage is not None:
            if usage < IDLE_THRESHOLD_MB:
                idle_counter += 1
                print(f"[{datetime.now().strftime('%H:%M:%S')}] Status: Idle ({usage} MB) | Counter: {idle_counter}/{MAX_IDLE_COUNT}")
            else:
                if idle_counter > 0:
                    print(f"[{datetime.now().strftime('%H:%M:%S')}] Status: Active ({usage} MB) | Counter reset to 0")
                idle_counter = 0
            
            if idle_counter >= MAX_IDLE_COUNT:
                # å‘é€ä»»åŠ¡å³å°†å…³é—­é€šçŸ¥
                send_notification(
                    notif_mgr,
                    "âš ï¸ GPUä»»åŠ¡å³å°†è‡ªåŠ¨å…³é—­",
                    f"ä»»åŠ¡ID: {JOB_ID}\n"
                    f"èŠ‚ç‚¹: {NODE_NAME}\n"
                    f"åŸå› : GPUè¿ç»­é—²ç½®{MAX_IDLE_COUNT}æ¬¡\n"
                    f"å½“å‰æ˜¾å­˜: {usage} MB\n"
                    f"è§¦å‘æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
                    f"2minåå°†ä¼šè‡ªåŠ¨å…³é—­ä»»åŠ¡ï¼Œè¯·åŠæ—¶æ£€æŸ¥bug"
                )
                time.sleep(120)

                if stop_job():
                    # å‘é€ä»»åŠ¡å·²å…³é—­é€šçŸ¥
                    send_notification(
                        notif_mgr,
                        "âœ… GPUä»»åŠ¡å·²æˆåŠŸå…³é—­",
                        f"ä»»åŠ¡ID: {JOB_ID}\n"
                        f"èŠ‚ç‚¹: {NODE_NAME}\n"
                        f"Pod: {POD_NAME}\n"
                        f"å…³é—­æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
                        f"è®¡è´¹å·²åœæ­¢"
                    )
                    break
                else:
                    # å‘é€å…³é—­å¤±è´¥é€šçŸ¥
                    send_notification(
                        notif_mgr,
                        "âŒ GPUä»»åŠ¡å…³é—­å¤±è´¥",
                        f"ä»»åŠ¡ID: {JOB_ID}\n"
                        f"å¤±è´¥æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
                        f"è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶å…³é—­ä»»åŠ¡"
                    )
        else:
            print("Can't get data")
            # å‘é€æ•°æ®è·å–å¤±è´¥é€šçŸ¥
            send_notification(
                notif_mgr,
                "âŒ GPUç›‘æ§æ•°æ®è·å–å¤±è´¥",
                f"ä»»åŠ¡ID: {JOB_ID}\n"
                f"å¤±è´¥æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
                f"ç›‘æ§ç¨‹åºå·²é€€å‡º"
            )
            return # Exit on data fetch failure

        time.sleep(CHECK_INTERVAL)

if __name__ == "__main__":
    main()

